<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <meta charset="utf-8" />
</head>
<body>
    <p><a href="Download02.ashx">1、边打包边下载</a></p>
    <p><a href="Download.ashx">2、http响应头兼容ie,firefox,chrome。中文文件名不乱码</a></p>
    <div>
        <p>3、分片上传,（查看控制台日志，修改配置文件，服务端存在上传文件的大小上限配置）</p>
        <input type="file"  name="chunkUpload" value="选择文件"  placeholder="选择文件" />
        <input type="file" name="chunkUploadDir" value="选择文件夹" placeholder="选择文件夹" webkitdirectory />
        <ul id="lstUploadFile">

        </ul>
    </div>
    <div>
        <p>3、浏览器计算md5（查看控制台日志）</p>
        <input type="file" name="calMd5" value="选择文件" />
    </div>
    <script src="jQuey/jquery-1.11.3.js"></script>
    <script src="spark-md5/spark-md5.js"></script>
    <script type="text/javascript">
        $(function () {
            $("input[name='chunkUpload']").change(function (sender) {
                var file = this.files[0];
                var chunkSize = 1024 * 1024 * 20;
                var elfile = $("<li></li>");
                $("<span></span>").html(file.name + "上传进度：").appendTo(elfile);
                var eljd = $("<span></span>");
                eljd.appendTo(elfile);
                $("<span></span>").html("%").appendTo(elfile);
                elfile.appendTo("#lstUploadFile");
                uploadFileByChunk(file, "Upload.ashx", {
                    chunkSize,
                    completeHandler: function (opt, resdata) {
                        eljd.html(100);
                        console.log("上传成功");
                    },
                    uploadingHandler: function (opt, resdata) {
                        eljd.html(parseInt(100.0 * opt.position / file.size));
                        console.log("正在上传");
                    },
                    errorHandler: function (opt,resdata) {
                        eljd.html("发生错误");
                    }
                })
                
                
            });
            $("input[name='chunkUploadDir']").change(function (sender) {
                var lstFile = $.makeArray(this.files);
                var lstFileWrapper=  $.map(lstFile, function (file,index) {
                    var elfile = $("<li></li>");
                    $("<span></span>").html((file.webkitRelativePath || file.name) + "上传进度：").appendTo(elfile);
                    var eljd = $("<span></span>");
                    eljd.appendTo(elfile);
                    $("<span></span>").html("%").appendTo(elfile);
                    elfile.appendTo("#lstUploadFile");
                    return { file, eljd };
                })
                console.log("lstFileWrapper", lstFileWrapper);
                var uploadHandler = function () {
                    var fileWrapper = lstFileWrapper.shift();
                    if (!fileWrapper)
                        return;
                    var chunkSize = 100;
                    var file = fileWrapper.file;
                    var eljd = fileWrapper.eljd;
                    uploadFileByChunk(file, "Upload.ashx", {
                        chunkSize,
                            completeHandler: function (opt, resdata) {
                                eljd.html(100);
                                console.log("上传成功");
                                uploadHandler();
                            },
                        uploadingHandler: function (opt, resdata) {
                            eljd.html(parseInt(100.0 * opt.position / file.size));
                            console.log("正在上传");
                        },
                        errorHandler: function (opt, resdata) {
                            eljd.html("发生错误");
                            uploadHandler();
                        }
                    })
                }
                for (var i = 0; i < 3; i++) {
                    uploadHandler();
                }
            });
            $("input[name='calMd5']").change(function () {
                console.log("calMd5");
                var blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice,
                    file = this.files[0],
                    chunkSize = 1024 * 1024 * 1,                             // Read in chunks of 2MB
                    chunks = Math.ceil(file.size / chunkSize),
                    currentChunk = 0,
                    spark = new SparkMD5.ArrayBuffer(),
                    fileReader = new FileReader();

                fileReader.onload = function (e) {
                    console.log('read chunk nr', currentChunk + 1, 'of', chunks);
                    spark.append(e.target.result);                   // Append array buffer
                    currentChunk++;

                    if (currentChunk < chunks) {
                        loadNext();
                    } else {
                        console.log('finished loading');
                        console.info('computed hash', spark.end());  // Compute hash
                    }
                };

                fileReader.onerror = function () {
                    console.warn('oops, something went wrong.');
                };

                function loadNext() {
                    var start = currentChunk * chunkSize,
                        end = ((start + chunkSize) >= file.size) ? file.size : start + chunkSize;

                    fileReader.readAsArrayBuffer(blobSlice.call(file, start, end));
                }

                loadNext();

            })
        });

        //opt:{formadataHandler, chunkSize,completeHandler,errorHandler,uploadingHandler}
        function uploadFileByChunk(file, url, opt) {
            opt.position = opt.position || 0;
            var buffer = file.slice(opt.position, opt.position + opt.chunkSize);
            var formdata = new FormData();
            formdata.append("FileEntity", buffer, file.name);
            formdata.append("Position", opt.position);
            formdata.append("FileSize", file.size);
            formdata.append("WebkitRelativePath", file.webkitRelativePath);
            opt.formadataHandler && opt.formadataHandler(formdata);
            $.ajax({
                "method": "POST",
                "url": url,
                "data": formdata,
                "processData": false,
                "contentType": false
            }).then(function (resdata) {
                opt.position = opt.position + opt.chunkSize;
                if (opt.position >= file.size) {
                    opt.completeHandler(opt, resdata);
                    return;
                }
                opt.uploadingHandler(opt,resdata);
                uploadFileByChunk(file, url, opt);
            }).fail(function (resdata) {
                opt.errorHandler(file,url,opt);
            });
        }
    </script>
</body>
</html>
